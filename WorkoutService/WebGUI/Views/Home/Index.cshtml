@model AnalyticsPageViewModel
@{
    ViewData["Title"] = "Fitness Cockpit";
    var summary = Model.Summary;
}

<div class="container py-4">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
        <div>
            <h1 class="display-6">Analytics-Dashboard</h1>
            <p class="text-muted mb-0">Live-Daten aus Workout-, Analytics- und Recommendation-Service.</p>
        </div>
        <a asp-action="Analytics" class="btn btn-outline-primary mt-3 mt-md-0">Detailanalyse öffnen</a>
    </div>

    @if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
    {
        <div class="alert alert-warning">@Model.ErrorMessage</div>
    }

    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body">
                    <p class="text-muted text-uppercase fw-semibold small">Letzte Einheit</p>
                    @if (Model.RecentWorkouts.Any())
                    {
                        var latest = Model.RecentWorkouts.First();
                        <h3>@latest.ExerciseType • @latest.Duration min</h3>
                        <p class="mb-0 text-success">@latest.Calories kcal</p>
                    }
                    else
                    {
                        <p class="mb-0">Keine Workouts im Zeitraum.</p>
                    }
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body">
                    <p class="text-muted text-uppercase fw-semibold small">Ø Dauer</p>
                    <h3>@(summary?.AverageDuration.ToString("0.0") ?? "–") min</h3>
                    <p class="mb-0 text-muted">Bereich: @summary?.PeriodStart.ToShortDateString() - @summary?.PeriodEnd.ToShortDateString()</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body">
                    <p class="text-muted text-uppercase fw-semibold small">Workouts gesamt</p>
                    <h3>@(summary?.TotalWorkouts.ToString() ?? "0")</h3>
                    <p class="mb-0 text-muted">Teilnehmer #@Model.Request.ParticipantId</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body">
                    <p class="text-muted text-uppercase fw-semibold small">Bestleistung</p>
                    <h3 class="fs-5">@summary?.BestPerformance ?? "Keine Daten"</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <h2 class="h5 mb-0">Letzte Trainings</h2>
                    <span class="text-muted small">WorkoutService</span>
                </div>
                <ul class="list-group list-group-flush">
                    @if (Model.RecentWorkouts.Any())
                    {
                        foreach (var workout in Model.RecentWorkouts)
                        {
                            <li class="list-group-item d-flex justify-content-between">
                                <div>
                                    <strong>@workout.ExerciseType</strong>
                                    <div class="text-muted small">@workout.Date:dd.MM.yyyy • @workout.Intensity</div>
                                </div>
                                <div class="text-end">
                                    <div>@workout.Duration min</div>
                                    <span class="badge bg-success">@workout.Calories kcal</span>
                                </div>
                            </li>
                        }
                    }
                    else
                    {
                        <li class="list-group-item text-muted">Keine Workouts im ausgewählten Zeitraum.</li>
                    }
                </ul>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header bg-transparent">
                    <h2 class="h5 mb-0">Analytics & Trends</h2>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        @foreach (var history in Model.History.Take(4))
                        {
                            <div class="col-6 col-md-3 mb-3">
                                <div class="text-muted small">@history.PeriodStart:MMM</div>
                                <div class="display-6 text-primary">@history.TotalWorkouts</div>
                                <p class="small text-muted mb-0">Sessions</p>
                            </div>
                        }
                    </div>
                    <hr/>
                    <p class="mb-0">
                        Daten aggregiert durch AnalyticsService (History-Tabelle). 
                        Aktualisiert: @(summary?.GeneratedAt.ToString("g") ?? "n/a").
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mt-1">
        <div class="col-lg-6">
            <div class="card h-100 border-primary">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <h2 class="h5 mb-0">Empfehlungen</h2>
                    <span class="badge bg-primary">RecommendationService</span>
                </div>
                <div class="card-body">
                    <h3 class="h6">Progressives Intervalltraining</h3>
                    <p class="text-muted">Sprint-Intervalle werden dynamisch vorgeschlagen, sobald Ø Kalorien sinkt.</p>
                    <hr>
                    <h3 class="h6">Proteinreiches Frühstück</h3>
                    <p class="text-muted mb-0">Ernährungstipp basierend auf Regenerationszeit nach Morgen-Sessions.</p>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header bg-transparent">
                    <h2 class="h5 mb-0">Participant Snapshot</h2>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 col-md-3 mb-3">
                            <div class="text-muted small">Teilnehmer</div>
                            <div class="fw-semibold">#@Model.Request.ParticipantId</div>
                        </div>
                        <div class="col-6 col-md-3 mb-3">
                            <div class="text-muted small">Zeitraum</div>
                            <div class="fw-semibold">@Model.Request.PeriodStart:dd.MM - @Model.Request.PeriodEnd:dd.MM</div>
                        </div>
                        <div class="col-6 col-md-3 mb-3">
                            <div class="text-muted small">Workouts</div>
                            <div class="fw-semibold">@summary?.TotalWorkouts ?? 0</div>
                        </div>
                        <div class="col-6 col-md-3 mb-3">
                            <div class="text-muted small">Kalorien</div>
                            <div class="fw-semibold">@summary?.TotalCalories.ToString("0") ?? "0"</div>
                        </div>
                    </div>
                    <p class="text-muted mb-0 text-center">Quelle: AnalyticsDb.History + WorkoutDb.Workouts.</p>
                </div>
            </div>
        </div>
    </div>
</div>