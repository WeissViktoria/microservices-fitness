@using WorkoutAnalyticsItem = WebGUI.Models.Analytics.WorkoutListItemViewModel
@model AnalyticsPageViewModel
@{
    ViewData["Title"] = "Workout Cockpit";
    var summary = Model.Summary;
    var workouts = Model.RecentWorkouts ?? new List<WorkoutAnalyticsItem>();
    var history = Model.History ?? new List<AnalyticsHistoryItemViewModel>();
}

<div class="container py-4">
    <header class="mb-4">
        <h1 class="display-6">Workout-Service Dashboard</h1>
        <p class="text-muted mb-0">Direkter Zugriff auf Workouts, Auswertungen, Empfehlungen.</p>
    </header>

    @if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
    {
        <div class="alert alert-warning">@Model.ErrorMessage</div>
    }

    <!-- Dashboard -->
    <section class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="h5 mb-0">Dashboard</h2>
            <form class="d-flex gap-2" asp-action="Analytics" method="get">
                <input type="number" min="1" class="form-control form-control-sm" name="participantId" value="@Model.Request.ParticipantId" />
                <input type="date" class="form-control form-control-sm" name="periodStart" value="@Model.Request.PeriodStart.ToString("yyyy-MM-dd")" />
                <input type="date" class="form-control form-control-sm" name="periodEnd" value="@Model.Request.PeriodEnd.ToString("yyyy-MM-dd")" />
                <button class="btn btn-outline-secondary btn-sm" type="submit">Aktualisieren</button>
            </form>
        </div>

        <div class="row g-3">
            <div class="col-md-3">
                <div class="card h-100">
                    <div class="card-body">
                        <p class="text-muted small text-uppercase mb-1">Ø Dauer</p>
                        <h3>@(summary?.AverageDuration.ToString("0.0") ?? "–") min</h3>
                        <p class="text-muted mb-0">Zeitraum @summary?.PeriodStart.ToShortDateString() – @summary?.PeriodEnd.ToShortDateString()</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card h-100">
                    <div class="card-body">
                        <p class="text-muted small text-uppercase mb-1">Kalorien</p>
                        <h3>@(summary?.TotalCalories.ToString("0") ?? "0") kcal</h3>
                        <p class="text-muted mb-0">Bestleistung: @summary?.BestPerformance ?? "n/a"</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card h-100">
                    <div class="card-body">
                        <p class="text-muted small text-uppercase mb-1">Workouts</p>
                        <h3>@(summary?.TotalWorkouts ?? 0)</h3>
                        <p class="text-muted mb-0">Teilnehmer #@Model.Request.ParticipantId</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card h-100">
                    <div class="card-body">
                        <p class="text-muted small text-uppercase mb-1">Letzte Einheit</p>
                        @if (workouts.Any())
                        {
                            var latest = workouts.First();
                            <h3>@latest.ExerciseType</h3>
                            <p class="text-success mb-0">@latest.Duration min • @latest.Calories kcal</p>
                        }
                        else
                        {
                            <p class="mb-0">Keine Daten im Zeitraum.</p>
                        }
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Workout-Erfassung -->
    <section class="mb-4">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="h5 mb-0">Workout-Erfassung</h2>
                        <small class="text-muted">Teilnehmer #@Model.Request.ParticipantId • WorkoutService (CRUD)</small>
                    </div>
                    <div class="text-muted small text-end">
                        <div>Übungsart • Dauer • Intensität • Wiederholungen</div>
                        <div>Alle Angaben werden direkt im WorkoutDB.Workouts gespeichert.</div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <form asp-controller="Workout" asp-action="Create" method="post" class="row g-3">
                    @Html.AntiForgeryToken()
                    <div class="col-md-2">
                        <label class="form-label">Teilnehmer</label>
                        <input class="form-control" type="number" min="1" name="CreateForm.ParticipantId" value="@Model.Request.ParticipantId" required />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Übungsart</label>
                        <input class="form-control" name="CreateForm.ExerciseType" placeholder="z.B. HIIT" required />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Dauer (min)</label>
                        <input class="form-control" type="number" min="1" max="300" name="CreateForm.Duration" value="30" required />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Wdh.</label>
                        <input class="form-control" type="number" min="0" max="1000" name="CreateForm.Repetitions" value="10" required />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Intensität</label>
                        <select class="form-select" name="CreateForm.Intensity">
                            <option>Niedrig</option>
                            <option>Mittel</option>
                            <option>Hoch</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Datum</label>
                        <input class="form-control" type="date" name="CreateForm.Date" value="@DateTime.Today:yyyy-MM-dd" required />
                    </div>
                    <div class="col-12">
                        <button class="btn btn-primary" type="submit">Workout speichern</button>
                        <a class="btn btn-outline-secondary" asp-controller="Workout" asp-action="Index" asp-route-participantId="@Model.Request.ParticipantId">Zur Verwaltung</a>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <!-- Analyse & Statistiken -->
    <section class="mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="h5 mb-0">Analyse & Statistiken</h2>
                    <small class="text-muted">Quelle: AnalyticsDb.History</small>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive mb-3">
                    <table class="table align-middle mb-0">
                        <thead class="table-light">
                        <tr>
                            <th>Zeitraum</th>
                            <th>Workouts</th>
                            <th>Ø Dauer</th>
                            <th>Kalorien</th>
                            <th>Bestleistung</th>
                        </tr>
                        </thead>
                        <tbody>
                        @if (history.Any())
                        {
                            foreach (var item in history)
                            {
                                <tr>
                                    <td>@item.PeriodStart:dd.MM.yyyy – @item.PeriodEnd:dd.MM.yyyy</td>
                                    <td>@item.TotalWorkouts</td>
                                    <td>@item.AverageDuration.ToString("0.0") min</td>
                                    <td>@item.TotalCalories.ToString("0") kcal</td>
                                    <td>@(string.IsNullOrWhiteSpace(item.BestPerformance) ? "–" : item.BestPerformance)</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="5" class="text-muted text-center">Keine Historie vorhanden.</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="p-3 bg-light rounded">
                            <h5>Trend</h5>
                            <p class="mb-1">Vergleich der letzten Perioden</p>
                            <ul class="mb-0">
                                <li>Workouts: @(history.Take(2).Select(h => h.TotalWorkouts).FirstOrDefault()) → @(history.Skip(1).Take(1).Select(h => h.TotalWorkouts).FirstOrDefault())</li>
                                <li>Dauer: @(history.Take(2).Select(h => h.AverageDuration.ToString("0")).FirstOrDefault()) → @(history.Skip(1).Take(1).Select(h => h.AverageDuration.ToString("0")).FirstOrDefault())</li>
                                <li>Kalorien: @(history.Take(2).Select(h => h.TotalCalories.ToString("0")).FirstOrDefault()) → @(history.Skip(1).Take(1).Select(h => h.TotalCalories.ToString("0")).FirstOrDefault())</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="p-3 border rounded">
                            <h5>Letzte Workouts</h5>
                            <ul class="list-unstyled mb-0">
                                @foreach (var workout in workouts.Take(5))
                                {
                                    <li class="mb-2 d-flex justify-content-between">
                                        <span>@workout.Date:dd.MM • @workout.ExerciseType</span>
                                        <span>@workout.Duration min / @workout.Calories kcal</span>
                                    </li>
                                }
                                @if (!workouts.Any())
                                {
                                    <li class="text-muted">Keine Workouts gefunden.</li>
                                }
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Empfehlungen -->
    <section>
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h2 class="h5 mb-0">Empfehlungen</h2>
                <small>RecommendationService</small>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <h6>Training</h6>
                        <p class="mb-0">Progressives Intervalltraining mit 30/90s Intervallen, sobald Ø Kalorien sinkt.</p>
                    </div>
                    <div class="col-md-4">
                        <h6>Ernährung</h6>
                        <p class="mb-0">30 g Protein innerhalb von 30 Minuten nach Morning-Workouts zur Regeneration.</p>
                    </div>
                    <div class="col-md-4">
                        <h6>Fortschritt</h6>
                        <p class="mb-0">Zwei Mobility-Sessions pro Woche halten Intensität hoch und senken Verletzungsrisiko.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

